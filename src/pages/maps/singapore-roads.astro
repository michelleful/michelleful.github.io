---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Singapore Road Names">
	<div id="map"></div>
	<div id="legend">
		<h3>Classification</h3>
		<div class="legend-item"><span class="swatch" style="background: #4444ff;"></span> British</div>
		<div class="legend-item"><span class="swatch" style="background: #ff4444;"></span> Chinese</div>
		<div class="legend-item"><span class="swatch" style="background: #999999;"></span> Generic</div>
		<div class="legend-item"><span class="swatch" style="background: #ffdd44;"></span> Indian</div>
		<div class="legend-item"><span class="swatch" style="background: #44cc44;"></span> Malay</div>
		<div class="legend-item"><span class="swatch" style="background: #cc44cc;"></span> Other</div>
	</div>
</Layout>

<style is:global>
	body {
		width: 100% !important;
		margin: 0 !important;
		background-color: #1a1a2e !important;
	}
	#map {
		width: 100%;
		height: 100vh;
	}
	#legend {
		position: absolute;
		top: 16px;
		right: 16px;
		background: rgba(20, 20, 40, 0.85);
		color: #ccc;
		padding: 12px 16px;
		border-radius: 8px;
		font-family: 'Jost', sans-serif;
		font-size: 0.9rem;
		z-index: 1;
	}
	#legend h3 {
		margin: 0 0 8px 0;
		font-size: 1rem;
		color: #fff;
	}
	.legend-item {
		display: flex;
		align-items: center;
		gap: 8px;
		margin-bottom: 4px;
	}
	.swatch {
		width: 20px;
		height: 4px;
		border-radius: 2px;
		display: inline-block;
	}
</style>

<script is:inline>
	const MAP_STYLE = 'https://basemaps.cartocdn.com/gl/dark-matter-nolabels-gl-style/style.json';

	function loadCSS(url) {
		const link = document.createElement('link');
		link.rel = 'stylesheet';
		link.href = url;
		document.head.appendChild(link);
	}

	function loadScript(url) {
		return new Promise((resolve, reject) => {
			const script = document.createElement('script');
			script.src = url;
			script.onload = resolve;
			script.onerror = reject;
			document.head.appendChild(script);
		});
	}

	loadCSS('https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css');
	loadScript('https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js').then(() => {
		const map = new maplibregl.Map({
			container: 'map',
			style: MAP_STYLE,
			center: [103.82, 1.35],
			zoom: 11,
		});

		map.on('load', () => {
			// Hide everything except land, water, and buildings
			const keep = ['background', 'landcover', 'landuse', 'water', 'waterway', 'boundary'];
			map.getStyle().layers.forEach((layer) => {
				if (!keep.some((k) => layer.id.includes(k))) {
					map.setLayoutProperty(layer.id, 'visibility', 'none');
				}
			});

			map.addSource('roads', {
				type: 'geojson',
				data: '/data/maps/singapore-roads-classified.geojson',
			});

			map.addLayer({
				id: 'roads-layer',
				type: 'line',
				source: 'roads',
				paint: {
					'line-color': [
						'match',
						['get', 'classification'],
						'British', '#4444ff',
						'Chinese', '#ff4444',
						'Generic', '#999999',
						'Indian', '#ffdd44',
						'Malay', '#44cc44',
						'Other', '#cc44cc',
						'#ffffff',
					],
					'line-width': 1.5,
					'line-opacity': 0.8,
				},
			});

			const popup = new maplibregl.Popup({
				closeButton: false,
				closeOnClick: false,
			});

			map.on('mouseenter', 'roads-layer', () => {
				map.getCanvas().style.cursor = 'pointer';
			});

			map.on('mouseleave', 'roads-layer', () => {
				map.getCanvas().style.cursor = '';
				popup.remove();
			});

			map.on('mousemove', 'roads-layer', (e) => {
				const feature = e.features[0];
				const name = feature.properties.name;
				const classification = feature.properties.classification;
				popup
					.setLngLat(e.lngLat)
					.setHTML('<strong>' + name + '</strong><br>' + classification)
					.addTo(map);
			});
		});
	});
</script>
